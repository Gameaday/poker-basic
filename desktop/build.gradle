// Pokermon Desktop - Native Executable Builds
// Creates platform-specific native executables

plugins {
    id 'org.jetbrains.kotlin.jvm'
    id 'application'
}

// Application configuration for desktop
application {
    mainClass = 'com.pokermon.GameLauncher'
}

// Java compatibility
java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

// Kotlin configuration
kotlin {
    jvmToolchain(17)
}

// Dynamic version from root project
version = rootProject.version
group = rootProject.group

// Dependencies - Use shared module
dependencies {
    implementation project(':shared')
    
    // Desktop-specific dependencies for native builds
    implementation "org.jetbrains.kotlin:kotlin-stdlib:${findProperty('kotlin.version') ?: '1.9.22'}"
    
    // For future native compilation support
    // implementation 'org.graalvm.nativeimage:svm:23.0.0' // Future: GraalVM Native Image
}

// Kotlin compilation options
tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile) {
    kotlinOptions {
        jvmTarget = '17'
        freeCompilerArgs += [
            '-Xjsr305=strict',
            '-opt-in=kotlin.ExperimentalStdlibApi'
        ]
    }
}

// Task to create Windows native executable (placeholder)
task packagewindows {
    group = 'native'
    description = 'Package Windows native executable (.exe)'
    
    doLast {
        println "=== Windows Native Build (Future Implementation) ==="
        println "Currently creating enhanced JAR for Windows compatibility"
        
        // Ensure shared JAR is built first
        if (!project(':shared').tasks.getByName('fatJar').state.executed) {
            project(':shared').tasks.getByName('fatJar').execute()
        }
        
        def buildDir = new File(project.buildDir, 'distributions')
        buildDir.mkdirs()
        
        def sharedLibsDir = new File(project(':shared').buildDir, 'libs')
        def sourceJar = sharedLibsDir.listFiles()
            ?.find { it.name.endsWith('-fat.jar') }
        
        if (sourceJar && sourceJar.exists()) {
            def targetFile = new File(buildDir, 'pokermon-windows.exe')
            // Copy instead of rename to preserve original
            targetFile.bytes = sourceJar.bytes
            println "Windows executable placeholder created: ${targetFile.absolutePath}"
        } else {
            throw new GradleException("Could not find fat JAR in ${sharedLibsDir}")
        }
    }
}

// Task to create Linux native executable (placeholder)  
task packagelinux {
    group = 'native'
    description = 'Package Linux native executable (.deb)'
    
    doLast {
        println "=== Linux Native Build (Future Implementation) ==="
        println "Currently creating enhanced JAR for Linux compatibility"
        
        // Ensure shared JAR is built first
        if (!project(':shared').tasks.getByName('fatJar').state.executed) {
            project(':shared').tasks.getByName('fatJar').execute()
        }
        
        def buildDir = new File(project.buildDir, 'distributions')
        buildDir.mkdirs()
        
        def sharedLibsDir = new File(project(':shared').buildDir, 'libs')
        def sourceJar = sharedLibsDir.listFiles()
            ?.find { it.name.endsWith('-fat.jar') }
        
        if (sourceJar && sourceJar.exists()) {
            def targetFile = new File(buildDir, 'pokermon-linux.deb')
            // Copy instead of rename to preserve original
            targetFile.bytes = sourceJar.bytes
            println "Linux executable placeholder created: ${targetFile.absolutePath}"
        } else {
            throw new GradleException("Could not find fat JAR in ${sharedLibsDir}")
        }
    }
}

// Task to create macOS native executable (placeholder)
task packagemacos {
    group = 'native'
    description = 'Package macOS native executable (.dmg)'
    
    doLast {
        println "=== macOS Native Build (Future Implementation) ==="
        println "Currently creating enhanced JAR for macOS compatibility"
        
        // Ensure shared JAR is built first
        if (!project(':shared').tasks.getByName('fatJar').state.executed) {
            project(':shared').tasks.getByName('fatJar').execute()
        }
        
        def buildDir = new File(project.buildDir, 'distributions')
        buildDir.mkdirs()
        
        def sharedLibsDir = new File(project(':shared').buildDir, 'libs')
        def sourceJar = sharedLibsDir.listFiles()
            ?.find { it.name.endsWith('-fat.jar') }
        
        if (sourceJar && sourceJar.exists()) {
            def targetFile = new File(buildDir, 'pokermon-macos.dmg')
            // Copy instead of rename to preserve original
            targetFile.bytes = sourceJar.bytes
            println "macOS executable placeholder created: ${targetFile.absolutePath}"
        } else {
            throw new GradleException("Could not find fat JAR in ${sharedLibsDir}")
        }
    }
}

// Task to create native executable for current platform
task packageNative {
    group = 'native'
    description = 'Package native executable for current platform'
    
    doLast {
        def osName = System.getProperty('os.name').toLowerCase()
        println "=== Detecting Platform: ${osName} ==="
        
        if (osName.contains('windows')) {
            println "Detected Windows platform"
        } else if (osName.contains('linux')) {
            println "Detected Linux platform"
        } else if (osName.contains('mac')) {
            println "Detected macOS platform"
        } else {
            println "Unknown platform: ${osName}, defaulting to JAR"
        }
        println "Platform-specific package created successfully"
    }
}

// Configure dependencies based on platform
def osName = System.getProperty('os.name').toLowerCase()
if (osName.contains('windows')) {
    packageNative.dependsOn packagewindows
} else if (osName.contains('linux')) {
    packageNative.dependsOn packagelinux
} else if (osName.contains('mac')) {
    packageNative.dependsOn packagemacos
} else {
    packageNative.dependsOn ':shared:fatJar'
}

// Development information task
task nativeInfo {
    group = 'help'
    description = 'Display native build information'
    
    doLast {
        println "=== Pokermon Native Build Information ==="
        println "Project: ${project.name}"
        println "Version: ${project.version}"
        println "Platform: ${System.getProperty('os.name')}"
        println ""
        println "Native Build Commands:"
        println "  ./gradlew :desktop:packageNative    - Build for current platform"
        println "  ./gradlew :desktop:packagewindows   - Build Windows .exe"
        println "  ./gradlew :desktop:packagelinux     - Build Linux .deb"
        println "  ./gradlew :desktop:packagemacos     - Build macOS .dmg"
        println ""
        println "Note: Native compilation is planned for future implementation."
        println "Currently generating enhanced JAR files as placeholders."
    }
}

// Ensure shared module JAR is built before packaging
packagewindows.dependsOn ':shared:fatJar'
packagelinux.dependsOn ':shared:fatJar'
packagemacos.dependsOn ':shared:fatJar'
packageNative.dependsOn ':shared:fatJar'