// Pokermon Shared - Enhanced for Native Build Support
// Gradual migration from JVM to Kotlin Multiplatform

import java.text.SimpleDateFormat
import java.util.Date

plugins {
    id 'org.jetbrains.kotlin.jvm'
    id 'org.jetbrains.kotlin.plugin.serialization'
    id 'java-library'
    id 'application'
}

apply plugin: 'org.jlleitschuh.gradle.ktlint'

// Dynamic version from root project
version = rootProject.version
group = rootProject.group

// Application configuration
application {
    mainClass = 'com.pokermon.GameLauncher'
}

// Java compatibility
java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

// Kotlin configuration
kotlin {
    jvmToolchain(17)
}

// Source sets prioritizing Kotlin
sourceSets {
    main {
        kotlin {
            srcDirs 'src/main/kotlin'
        }
        java {
            srcDirs 'src/main/java'
        }
        resources {
            srcDirs 'src/main/resources'
        }
    }
    test {
        kotlin {
            srcDirs 'src/test/kotlin'
        }
        java {
            srcDirs 'src/test/java'
        }
        resources {
            srcDirs 'src/test/resources'
        }
    }
}

// Dependencies - Pure Kotlin-native stack
dependencies {
    // Kotlin standard library and coroutines
    implementation "org.jetbrains.kotlin:kotlin-stdlib:${findProperty('kotlin.version') ?: '2.2.10'}"
    implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:${findProperty('kotlinx.coroutines.version') ?: '1.7.3'}"
    implementation "org.jetbrains.kotlinx:kotlinx-serialization-json:1.9.0"
    
    // Testing with Kotlin support
    testImplementation 'org.junit.jupiter:junit-jupiter:6.0.1'
    testImplementation "org.jetbrains.kotlin:kotlin-test:${findProperty('kotlin.version') ?: '2.2.10'}"
    testImplementation "org.jetbrains.kotlin:kotlin-test-junit5:${findProperty('kotlin.version') ?: '2.2.10'}"
}

// Enhanced test configuration
test {
    useJUnitPlatform()
    maxParallelForks = Runtime.runtime.availableProcessors()
    
    // Test logging
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
    }
    
    // System properties for tests
    systemProperty 'kotlin.test.junit5.displayMode', 'verbose'
}

// Make compilation depend on up-to-date check
compileKotlin.dependsOn checkKotlinGradlePluginConfigurationErrors

// Handle duplicate resources
processResources {
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

// Fat JAR for standalone execution
task fatJar(type: Jar) {
    group = 'build'
    description = 'Creates executable JAR with all dependencies'
    
    archiveBaseName = 'pokermon'
    archiveClassifier = 'fat'
    from sourceSets.main.output
    
    dependsOn configurations.runtimeClasspath
    from {
        configurations.runtimeClasspath.findAll { it.name.endsWith('jar') }.collect { zipTree(it) }
    }
    
    manifest {
        attributes(
            'Implementation-Title': 'Pokermon Enhanced for Native',
            'Implementation-Version': project.version,
            'Main-Class': 'com.pokermon.GameLauncher',
            'Built-By': System.getProperty('user.name'),
            'Built-Date': new Date().toString(),
            'Kotlin-Version': findProperty('kotlin.version') ?: '2.2.10'
        )
    }
    
    // Exclude duplicate files
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

// Task to run console version
task runConsole(type: JavaExec) {
    group = 'application'
    description = 'Run Pokermon in console mode'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.pokermon.ConsoleMainKt'
    args '--basic'
}

// Task for development builds with version info
task developmentInfo {
    group = 'help'
    description = 'Display development information'
    
    doLast {
        println "=== Pokermon Kotlin-Native Development Info ==="
        println "Project: ${project.name}"
        println "Version: ${project.version}"
        println "Kotlin: ${findProperty('kotlin.version') ?: '2.2.10'}"
        println "Main class: ${application.mainClass.get()}"
        println ""
        println "Available tasks:"
        println "  ./gradlew :shared:fatJar       - Build executable JAR"
        println "  ./gradlew :shared:runConsole   - Run console version"
        println "  ./gradlew :shared:test         - Run tests"
        println "  ./gradlew :shared:run          - Run GUI version"
    }
}

// Kotlin compilation options with production optimizations
tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile) {
    kotlinOptions {
        jvmTarget = '17'
        
        // Base compiler arguments
        def baseArgs = [
            '-Xjsr305=strict',
            '-opt-in=kotlin.ExperimentalStdlibApi',
            '-opt-in=kotlinx.coroutines.ExperimentalCoroutinesApi'
        ]
        
        // Add production optimizations for non-development builds
        def isDevelopment = project.hasProperty('developmentBuild') && project.developmentBuild
        if (!isDevelopment) {
            baseArgs += [
                '-Xno-call-assertions',
                '-Xno-param-assertions', 
                '-Xno-receiver-assertions',
                '-Xassertions=legacy'
            ]
        }
        
        freeCompilerArgs = baseArgs
    }
}

// Ktlint configuration for code quality
ktlint {
    version = "1.0.1"
    debug = false
    verbose = false
    android = false
    outputToConsole = true
    ignoreFailures = true
    reporters {
        reporter "checkstyle"
        reporter "plain"
    }
    filter {
        exclude("**/build/**")
        exclude("**/test/**/*.kt")
    }
}

// Linting tasks
task lint {
    group = 'verification'
    description = 'Run all linting checks'
    dependsOn ktlintCheck
}

task lintFix {
    group = 'formatting'
    description = 'Fix all linting issues automatically'
    dependsOn ktlintFormat
}

// Native compilation tasks using local kotlinc-native
def kotlinNativeHome = findProperty('kotlin.native.home') ?: "${projectDir}/../kotlin-native-linux-x86_64-1.9.22"
def kotlincNative = "${kotlinNativeHome}/bin/kotlinc-native"

task buildNativeLinux {
    group = 'native'
    description = 'Build native executable for Linux using kotlinc-native'
    dependsOn compileKotlin
    
    doLast {
        println "=== Building Native Linux Executable ==="
        println "Using Kotlin/Native compiler: ${kotlincNative}"
        
        def outputDir = new File(buildDir, "native/linux")
        outputDir.mkdirs()
        
        // Only compile the native entry point and its dependencies for now
        def sourceFile = new File(projectDir, 'src/main/kotlin/com/pokermon/native/NativeMain.kt')
        
        if (!sourceFile.exists()) {
            throw new GradleException("Source file not found: ${sourceFile.absolutePath}")
        }
        
        def outputFile = new File(outputDir, "pokermon-linux")
        
        def compileCmd = [
            kotlincNative,
            '-produce', 'program',
            '-output', outputFile.absolutePath,
            '-opt',  // Enable optimizations
            sourceFile.absolutePath
        ]
        
        println "Running: ${compileCmd.join(' ')}"
        
        def process = compileCmd.execute()
        process.waitFor()
        
        if (process.exitValue() == 0) {
            println "‚úÖ Native Linux executable built successfully!"
            println "  üì¶ ${outputFile.absolutePath}"
            
            // Make executable
            outputFile.setExecutable(true)
            
            def size = (outputFile.length() / 1024 / 1024).round(2)
            println "  üìä Size: ${size} MB"
        } else {
            println "‚ùå Native compilation failed:"
            println process.errorStream.text
            throw new GradleException("Native Linux compilation failed")
        }
    }
}

task buildNativeWindows {
    group = 'native'
    description = 'Build native executable for Windows using kotlinc-native'
    dependsOn compileKotlin
    
    doLast {
        println "=== Building Native Windows Executable ==="
        println "Using Kotlin/Native compiler: ${kotlincNative}"
        
        def outputDir = new File(buildDir, "native/windows")
        outputDir.mkdirs()
        
        def sourceFile = new File(projectDir, 'src/main/kotlin/com/pokermon/native/NativeMain.kt')
        
        if (!sourceFile.exists()) {
            throw new GradleException("Source file not found: ${sourceFile.absolutePath}")
        }
        
        def outputFile = new File(outputDir, "pokermon-windows.exe")
        
        def compileCmd = [
            kotlincNative,
            '-produce', 'program',
            '-target', 'mingw_x64',
            '-output', outputFile.absolutePath,
            '-opt',  // Enable optimizations
            sourceFile.absolutePath
        ]
        
        println "Running: ${compileCmd.join(' ')}"
        
        def process = compileCmd.execute()
        process.waitFor()
        
        if (process.exitValue() == 0) {
            println "‚úÖ Native Windows executable built successfully!"
            println "  üì¶ ${outputFile.absolutePath}"
            
            def size = (outputFile.length() / 1024 / 1024).round(2)
            println "  üìä Size: ${size} MB"
        } else {
            println "‚ùå Native compilation failed:"
            println process.errorStream.text
            println "‚ÑπÔ∏è  Cross-compilation may require additional setup"
        }
    }
}

task buildNativeMacOS {
    group = 'native'
    description = 'Build native executable for macOS using kotlinc-native'
    dependsOn compileKotlin
    
    doLast {
        println "=== Building Native macOS Executable ==="
        println "Using Kotlin/Native compiler: ${kotlincNative}"
        
        def outputDir = new File(buildDir, "native/macos")
        outputDir.mkdirs()
        
        def sourceFile = new File(projectDir, 'src/main/kotlin/com/pokermon/native/NativeMain.kt')
        
        if (!sourceFile.exists()) {
            throw new GradleException("Source file not found: ${sourceFile.absolutePath}")
        }
        
        def outputFile = new File(outputDir, "pokermon-macos")
        
        def compileCmd = [
            kotlincNative,
            '-produce', 'program',
            '-target', 'macos_x64',
            '-output', outputFile.absolutePath,
            '-opt',  // Enable optimizations
            sourceFile.absolutePath
        ]
        
        println "Running: ${compileCmd.join(' ')}"
        
        def process = compileCmd.execute()
        process.waitFor()
        
        if (process.exitValue() == 0) {
            println "‚úÖ Native macOS executable built successfully!"
            println "  üì¶ ${outputFile.absolutePath}"
            
            // Make executable
            outputFile.setExecutable(true)
            
            def size = (outputFile.length() / 1024 / 1024).round(2)
            println "  üìä Size: ${size} MB"
        } else {
            println "‚ùå Native compilation failed:"
            println process.errorStream.text
            println "‚ÑπÔ∏è  Cross-compilation may require additional setup"
        }
    }
}

task buildNativeAll {
    group = 'native'
    description = 'Build native executables for all platforms'
    dependsOn buildNativeLinux, buildNativeWindows, buildNativeMacOS
}

// Information task for native builds
task nativeInfo {
    group = 'help'
    description = 'Display native build information and available commands'
    
    doLast {
        println "=== Pokermon Kotlin/Native Build Information ==="
        println "Project: ${project.name}"
        println "Version: ${project.version}"
        println "Kotlin: ${findProperty('kotlin.version') ?: '2.2.10'}"
        println ""
        println "Available Native Targets:"
        println "  Linux x64:   kotlinc-native with LLVM backend"
        println "  Windows x64: MinGW cross-compilation"
        println "  macOS x64:   Cross-compilation (requires macOS for signing)"
        println ""
        println "Native Build Commands:"
        println "  ./gradlew :shared:buildNativeLinux    - Build Linux native executable"
        println "  ./gradlew :shared:buildNativeWindows  - Build Windows native executable"
        println "  ./gradlew :shared:buildNativeMacOS    - Build macOS native executable"
        println "  ./gradlew :shared:buildNativeAll      - Build all native executables"
        println ""
        println "JVM Build Commands (for development):"
        println "  ./gradlew :shared:fatJar              - Build JVM executable JAR"
        println "  ./gradlew :shared:runConsole          - Run console version (JVM)"
        println "  ./gradlew :shared:test                - Run tests (JVM)"
        println ""
        println "‚úÖ True Kotlin/Native compilation - no Java runtime required!"
    }
}